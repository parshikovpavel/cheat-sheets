https://go.dev/ref/spec

В Go есть две *predefined function*'s, зарезервированные для особых целей. Один из них — *init()* , а другой — *main()*

*Variable*'s могут быть инициализированы с помощью *function*'s с именем `init` (таких *function*'s может быть несколько). Они должны быть *declare* в *package block* без *argument*'s и *result*'s.

```go
func init() { 
  // ...
}
```

Для каждого *package* может быть определено несколько таких *function*'s, даже в одном исходном файле. 

```go
func init() {
	fmt.Println("init_1")
}

func init() {
	fmt.Println("init_2")
}

func main() {
	fmt.Println("main")
}
```

Будет выведено:

```
init_1
init_2
main
```



В *package block* `init` *identifier* может использоваться только чтобы *declare* `init` *function*'s, но при этом не происходит *declare* самого *identifier*'а. Таким образом, на `init` *function*'s нельзя ссылаться из какой-либо точки программы.

*Package* без `import`'ов инициализируется путем присвоения *initial value*'s всем его *package-level variable*'s с последующим вызовом всех `init` функций в том порядке, в котором они появляются в исходном коде, возможно, в нескольких файлах, как они представлены компилятору. Если *package* имеет `import`'ы, импортированные *package*'s инициализируются перед инициализацией самого *package*. Если несколько *package*'s импортируют *package*, импортированный *package* будет инициализирован только один раз. Поэтому независимо от того, сколько раз был импортирован этот пакет, `init()`функция будет вызываться только один раз. Golang не позволяет делать циклические `import`'ы. Поэтому при импортировании *package*'s гарантировано отсутствие циклических зависимостей инициализации.

Инициализация *package*'s (инициализация *variable*'s и вызов `init` *function*'s) — происходит в одной *goroutine* последовательно, по одному *package* в один момент времени. *Function* `init ` может запускать другие *goroutine*'s, которые могут выполняться одновременно с кодом инициализации. Однако инициализация всегда выполняет последовательно `init` *function*'s: она не будет вызывать следующую, пока не завершится предыдущая.

Чтобы обеспечить воспроизводимое поведение при инициализации, системам *building*'а рекомендуется выдавать компилятору файлы, принадлежащих одному и тому же *package*, в лексическом порядке *file name*.

# Паттерны применения

## Антипаттерн

Иногда при запуске приложения необходимо задать некоторое начальное состояние. Например, установить соединений с *database* или загрузить конфигурацию из локального файла. Для этого случая не стоит использовать функцию `init()`. В этом случае лучше использовать функцию-конструктор `New()`:

```go
func New() (*Database, error) {
    conn, err := sql.Open("postgres", "connectionURI")
    if err != nil {
        return &Database{}, err
    }
    return &Database{
        Connection: conn,
    }, nil
}
```

Такая реализация позволяет гораздо удобнее обрабатывать сбои во время запуска.

Поэтому необходимо избегать использования `init` *function* везде, где это возможно, и стараться использовать функцию-конструктор.

## Запуск *rand generator*

`init()` используется для запуска *rand generator*:

```go
func init() {
	rand.Seed(time.Now().UnixNano())
}
```

## Side effect

Иногда `init()` *function* выполняет регистрацию какой-то функциональности. В этом случае обязательно делать *import* для *package* из-за этого *side effect*, даже в том случае если не происходит обращение к его *function*'s. Т.к. мы не обращаемся к *function*'s при *import*'е необходимо использовать [*blank identifier*](Lang.go#blank-identifier).

### Пример 

При использовании [`image`package](https://golang.org/pkg/image/) для декодирование конкретного формата *image* необходимо предварительно зарегистрировать *decoder function*. Регистрация выполняется как *side effect* инициализации *package* этого формата. Например, для декодирования *PNG image* необходимо написать:

```
import _ "image/png"
```

в *main package*. `_` означает *import a package* исключительно из-за его *initialization side effect*'ов.

Если заглянуть в исходники `image/png` *package*, то можно увидеть следующее объявление:

```go
func init() {
	image.RegisterFormat("png", pngHeader, Decode, DecodeConfig)
}
```

